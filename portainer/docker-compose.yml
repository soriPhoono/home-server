version: "3.8"

services:
  portainer:
    image: portainer/portainer-ce:lts
    command: -H tcp://tasks.agent:9001 --tlsskipverify
    volumes:
      - portainer-data:/data
    ports:
      - target: 8000
        published: 8000
        protocol: tcp
        mode: host
    networks:
      - agent-network
      - portainer_traefik-public
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: [node.role == manager]
      labels:
        - traefik.enable=true

        - traefik.http.routers.portainer.rule=Host(`admin.${DOMAIN_NAME}`)
        - traefik.http.routers.portainer.entrypoints=websecure
        - traefik.http.routers.portainer.tls=true
        - traefik.http.routers.portainer.tls.certresolver=le

        - traefik.http.services.portainer.loadbalancer.server.port=9000

  agent:
    image: portainer/agent:lts
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
    networks:
      - agent-network
    deploy:
      mode: global
      placement:
        constraints: [node.platform.os == linux]

  shepherd:
    image: containrrr/shepherd
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      placement:
        constraints:
          - node.role == manager

  traefik:
    image: traefik:latest
    command:
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.http.tls=true
      - --entrypoints.traefik.address=:8080 # For the dashboard/API

      # Docker Swarm Provider (Dynamic Configuration source)
      - --providers.swarm.endpoint=unix:///var/run/docker.sock
      - --providers.swarm.watch=true
      - --providers.swarm.exposedbydefault=false
      - --providers.swarm.network=portainer_traefik-public

      # API and Dashboard
      - --api.dashboard=true
      - --api.insecure=false # WARNING: Do not use in production without proper BasicAuth middleware

      # TODO: Check this is working properly (TLS enabled on all domains not just cloudflare but tailscale custom endpoints on domain name as well)
      # ACME / Let's Encrypt setup (Optional)
      - --certificatesresolvers.le.acme.email=your@email.com
      - --certificatesresolvers.le.acme.storage=/acme/acme.json
      - --certificatesresolvers.le.acme.dnschallenge=true
      - --certificatesresolvers.le.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.le.acme.dnschallenge.resolvers=1.1.1.1:53,1.0.0.1:53 # Recommended DNS resolvers for the challenge
      - --certificatesresolvers.le.acme.dnschallenge.delayBeforeCheck=0 # Optional, but helps speed up the check

      # Observability
      - --log.level=INFO # Set the Log Level e.g INFO, DEBUG
      - --accesslog=true # Enable Access Logs
      - --metrics.prometheus=true # Enable Prometheus

      # Optional: Enable redirect middleware for all HTTP to HTTPS traffic
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
    ports:
      - target: 80 # HTTP
        published: 80
        protocol: tcp
        mode: host
      - target: 443 # HTTPS
        published: 443
        protocol: tcp
        mode: host
    secrets:
      - portainer_cf_token
    volumes:
      # Mount the Docker socket for service discovery (Traefik reads container labels)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount the ACME file for persistent certificates
      - traefik-certs:/acme
    environment:
      - CF_DNS_API_TOKEN_FILE=/run/secrets/portainer_cf_token
    networks:
      - portainer_traefik-public
    deploy:
      mode: replicated # Can be 'global' or 'replicated'
      replicas: 1
      placement:
        constraints:
          - node.role == manager # Recommended to run Traefik only on a manager node for stability
      labels:
        - traefik.enable=true

        # Dashboard router
        - traefik.http.routers.dashboard.rule=Host(`traefik.admin.${DOMAIN_NAME}`)
        - traefik.http.routers.dashboard.entrypoints=websecure
        - traefik.http.routers.dashboard.service=api@internal
        - traefik.http.routers.dashboard.tls=true

        # Basicâ€‘auth middleware
        - traefik.http.middlewares.dashboard-auth.basicauth.users=admin:$$apr1$$hpN8qr0J$$frjpxwhIw.OG0R2yn5dqW.
        - traefik.http.routers.dashboard.middlewares=dashboard-auth@swarm

        # Service hint
        - traefik.http.services.traefik.loadbalancer.server.port=8080

networks:
  agent-network:
    driver: overlay
  portainer_traefik-public:
    external: true

volumes:
  traefik-certs:
  portainer-data:

secrets:
  portainer_cf_token:
    external: true
