# Docker Compose file for Caddy reverse proxy with Watchtower update service
# Using Cloudflare for DNS challenge automation for TLS certificates
#
# Required environment variables:
# - CLOUDFLARE_EMAIL: Your Cloudflare account email
# - CLOUDFLARE_API_TOKEN: Your Cloudflare API token with DNS edit permissions
# - DOMAIN_NAME: The domain name to be used for the reverse proxy

version: "3.8"

services:
  # Watchtower service to automatically update Docker containers
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # Caddy reverse proxy service
  caddy:
    image: homeall/caddy-reverse-proxy-cloudflare:latest
    container_name: caddy
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

      - caddy_config:/data/caddy/
    ports:
      - 80:80
      - 443:443
      - 443:443/udp
    networks:
      reverse_proxy_network:
        ipv4_address: 192.168.25.24
    labels:
      caddy.email: ${CLOUDFLARE_EMAIL:?cloudflare email is not set}
      caddy.acme_dns: cloudflare ${CLOUDFLARE_API_TOKEN:?cloudflare api token is not set}

      caddy_0: admin.tail.${DOMAIN_NAME:?domain name is not set}
      caddy_0.reverse_proxy: http://portainer-server-be:9000
      caddy_0.tls.protocols: tls1.3

volumes:
  caddy_config:

networks:
  reverse_proxy_network:
    external: true
