services:
  traefik:
    image: traefik:latest
    restart: always
    container_name: traefik
    command:
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.transport.respondingTimeouts.readTimeout=24h
      - --entrypoints.websecure.http.tls=true
      - --entrypoints.traefik.address=:8080 # For the dashboard/API
      # Docker provider setup
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=proxy_default
      # API and Dashboard
      - --api.dashboard=true
      - --api.insecure=false # WARNING: Do not use in production without proper BasicAuth middleware
      # TODO: Check this is working properly (TLS enabled on all domains not just cloudflare but tailscale custom endpoints on domain name as well)
      # ACME / Let's Encrypt setup (Optional)
      - --certificatesresolvers.le.acme.email=admin@${DOMAIN_NAME}
      - --certificatesresolvers.le.acme.storage=/acme/acme.json
      # - --certificatesresolvers.le.acme.tlschallenge=true
      - --certificatesresolvers.le.acme.dnschallenge=true
      - --certificatesresolvers.le.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.le.acme.dnschallenge.resolvers=1.1.1.1:53,1.0.0.1:53 # Recommended DNS resolvers for the challenge
      - --certificatesresolvers.le.acme.dnschallenge.delayBeforeCheck=0 # Optional, but helps speed up the check
      # Observability
      - --log.level=INFO # Set the Log Level e.g INFO, DEBUG
      - --accesslog=true # Enable Access Logs
      - --metrics.prometheus=true # Enable Prometheus
      # Optional: Enable redirect middleware for all HTTP to HTTPS traffic
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
    environment:
      - CLOUDFLARE_DNS_API_TOKEN=${CF_API_TOKEN} # Cloudflare API key for DNS challenge
      - CLOUDFLARE_ZONE_API_TOKEN=${CF_API_TOKEN} # Cloudflare Zone API token for DNS challenge
    volumes:
      # Mount the Docker socket for service discovery (Traefik reads container labels)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount the ACME file for persistent certificates
      - traefik-certs:/acme
    networks:
      default:
        ipv4_address: 172.18.0.5
    ports:
      - 80:80 # The HTTP port
      - 443:443 # The HTTPS port
    logging:
      driver: loki
      options:
        loki-url: http://localhost:3100/loki/api/v1/push
    labels:
      - traefik.enable=true
      # Dashboard router
      - traefik.http.routers.dashboard.rule=Host(`proxy.admin.${DOMAIN_NAME}`)
      - traefik.http.routers.dashboard.entrypoints=websecure
      - traefik.http.routers.dashboard.service=api@internal
      - traefik.http.routers.dashboard.tls=true
      - traefik.http.routers.dashboard.middlewares=dashboard-auth@docker
      # Basicâ€‘auth middleware
      - traefik.http.middlewares.dashboard-auth.basicauth.users=admin:$$apr1$$hpN8qr0J$$frjpxwhIw.OG0R2yn5dqW.
      # Service hint
      - traefik.http.services.traefik.loadbalancer.server.port=8080
networks:
  default:
    ipam:
      config:
        - subnet: 172.18.0.0/16
volumes:
  traefik-certs:
