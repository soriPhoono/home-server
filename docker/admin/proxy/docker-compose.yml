services:
  traefik:
    image: traefik:latest
    command:
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.http.tls=true
      - --entrypoints.traefik.address=:8080 # For the dashboard/API

      # Docker Swarm Provider (Dynamic Configuration source)
      - --providers.swarm.endpoint=unix:///var/run/docker.sock
      - --providers.swarm.watch=true
      - --providers.swarm.exposedbydefault=false
      - --providers.swarm.network=proxy_public

      # API and Dashboard
      - --api.dashboard=true
      - --api.insecure=false # WARNING: Do not use in production without proper BasicAuth middleware

      # TODO: Check this is working properly (TLS enabled on all domains not just cloudflare but tailscale custom endpoints on domain name as well)
      # ACME / Let's Encrypt setup (Optional)
      - --certificatesresolvers.le.acme.email=admin@${DOMAIN_NAME}
      - --certificatesresolvers.le.acme.storage=/acme/acme.json
      - --certificatesresolvers.le.acme.dnschallenge=true
      - --certificatesresolvers.le.acme.dnschallenge.provider=cloudflare
      - --certificatesresolvers.le.acme.dnschallenge.resolvers=1.1.1.1:53,1.0.0.1:53 # Recommended DNS resolvers for the challenge
      - --certificatesresolvers.le.acme.dnschallenge.delayBeforeCheck=0 # Optional, but helps speed up the check

      # Observability
      - --log.level=INFO # Set the Log Level e.g INFO, DEBUG
      - --accesslog=true # Enable Access Logs
      - --metrics.prometheus=true # Enable Prometheus

      # Optional: Enable redirect middleware for all HTTP to HTTPS traffic
      - --entrypoints.web.http.redirections.entrypoint.to=websecure
      - --entrypoints.web.http.redirections.entrypoint.scheme=https
      - --entrypoints.web.http.redirections.entrypoint.permanent=true
    ports:
      - target: 80 # HTTP
        published: 80
        protocol: tcp
        mode: host
      - target: 443 # HTTPS
        published: 443
        protocol: tcp
        mode: host
    secrets:
      - proxy_traefik-cf-token
    volumes:
      # Mount the Docker socket for service discovery (Traefik reads container labels)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Mount the ACME file for persistent certificates
      - traefik-certs:/acme
    environment:
      - CF_API_EMAIL_FILE=/run/secrets/proxy_traefik-cf-email
      - CF_DNS_API_TOKEN_FILE=/run/secrets/proxy_traefik-cf-token
    networks:
      - public
    deploy:
      mode: replicated # Can be 'global' or 'replicated'
      replicas: 1
      placement:
        constraints:
          - node.role == manager # Recommended to run Traefik only on a manager node for stability
      labels:
        - traefik.enable=true

        # Dashboard router
        - traefik.http.routers.dashboard.rule=Host(`proxy.admin.${DOMAIN_NAME}`)
        - traefik.http.routers.dashboard.entrypoints=websecure
        - traefik.http.routers.dashboard.service=api@internal
        - traefik.http.routers.dashboard.tls=true

        # Basicâ€‘auth middleware
        - traefik.http.middlewares.dashboard-auth.basicauth.users=admin:$$apr1$$hpN8qr0J$$frjpxwhIw.OG0R2yn5dqW.
        - traefik.http.routers.dashboard.middlewares=dashboard-auth@swarm

        # Service hint
        - traefik.http.services.traefik.loadbalancer.server.port=8080

networks:
  public:
    driver: overlay
    attachable: true

volumes:
  traefik-certs:

secrets:
  proxy_traefik-cf-email:
    external: true
  proxy_traefik-cf-token:
    external: true