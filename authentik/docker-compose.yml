version: "3.8"

services:
  migrations:
    image: postgres:18-alpine
    command: ["sh", "-c", "sleep 10; /init/init-db.sh"]
    volumes:
      - ./init:/init:ro
    secrets:
      - postgres_password
      - authentik_db_owner_password
    networks:
      - backend_default
    deploy:
      replicas: 1
      restart_policy:
        condition: none

  worker:
    image: ghcr.io/goauthentik/server:2025.10.1
    command: worker
    depends_on:
      - migrations
    environment:
      AUTHENTIK_POSTGRESQL__HOST: postgres
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_POSTGRESQL__PASSWORD: file:///run/secrets/authentik_db_owner_password
      AUTHENTIK_POSTGRESQL__USER: authentik
      AUTHENTIK_SECRET_KEY: /run/secrets/authentik_secret_key
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - authentik-media:/media
      - authentik-certs:/certs
      - authentik-templates:/templates
    secrets:
      - authentik_db_owner_password
      - authentik_secret_key
    networks:
      - backend_default
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  server:
    image: ghcr.io/goauthentik/server:2025.10.1
    command: server
    depends_on:
      - migrations
    environment:
      AUTHENTIK_POSTGRESQL__HOST: postgres
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_POSTGRESQL__PASSWORD: file:///run/secrets/authentik_db_owner_password
      AUTHENTIK_POSTGRESQL__USER: authentik
      AUTHENTIK_SECRET_KEY: /run/secrets/authentik_secret_key
    volumes:
      - authentik-media:/media
      - authentik-templates:/templates
    secrets:
      - authentik_db_owner_password
      - authentik_secret_key
    ports:
      - target: 9000
        published: 9000
        protocol: tcp
        mode: host
      - target: 9443
        published: 9443
        protocol: tcp
        mode: host
    networks:
      - backend_default
      - portainer_traefik-public
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      labels:
        - traefik.enable=true

        - traefik.http.routers.authentik.rule=Host(`auth.localhost`)
        - traefik.http.routers.authentik.entrypoints=websecure
        - traefik.http.routers.authentik.tls=true
        - traefik.http.routers.authentik.tls.certresolver=le

        - traefik.http.services.authentik.loadbalancer.server.port=9000
secrets:
  postgres_password:
    external: true
  authentik_db_owner_password:
    external: true
  authentik_secret_key:
    external: true

volumes:
  authentik-media:
  authentik-templates:
  authentik-certs:

networks:
  backend_default:
    external: true
  portainer_traefik-public:
    external: true
